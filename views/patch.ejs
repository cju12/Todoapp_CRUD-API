<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo app</title>
    <link rel="stylesheet" href="patchstyle.css">
</head>
<body>
    <div class="container">
        <label for="text">text</label><br />
        <textarea name="change" cols="50" rows="15" id="change" required placeholder="What do you want to change?"><%= todo.text %></textarea><br />

        <!--
        changing the priority

        the previously selected priority is selected by default
        -->
        <label for="priority">Priority</label>
        <select id="priority" name="priority" required>
            <option value="" disabled selected>Select priority</option>
            <option value="high" <%= (todo.priority === 'high' ? 'selected' : '') %> >High</option>
            <option value="middle" <%= (todo.priority === 'middle' ? 'selected' : '') %> >Middle</option>
            <option value="low" <%= (todo.priority === 'low' ? 'selected' : '') %> >Low</option>
        </select><br />
        
        <!--

        changing the deadline

        -->
        <label for="deadline">Deadline (dd/mm/yyyy)</label>
        <input type="text" id="deadline" name="deadline" required pattern="\d{2}/\d{2}/\d{4}" placeholder="e.g. 20/04/2025"><br />

        <button type="submit" id="editSubmitButton">Submit</button>
        <a href="/"><button type="button">Back</button></a>
    </div>
</body>
<script>

/**
 *  This function is used to check if the date is valid or not
 *  Returning true if the date is valid and false if the date is invalid
*/

    isValidDate = (dateString) => {
        const dateList = dateString.split("/"); // Split the datestring in to an array of strings
        if (dateList.length !== 3) return false; // Check if the date string has exactly 3 parts

        // make 3 variables for the day, month and year
        const day = parseInt(dateList[0], 10);
        const month = parseInt(dateList[1], 10);
        const year = parseInt(dateList[2], 10); 

        const date = new Date(year, month - 1, day); // Month is 0-based in JavaScript date object (e.g, January is 0, February is 1, etc.)
        // Check if the date is valid by comparing the input values with the date object values
        return (date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day); 
    }


    /**
     * 
     * this function is used to send the edited data to the server
     * the data id of the todo is passed to the server already through the api & the url
     * 
     * 
     * */    

    const regex = /^([0]?[1-9]|[12][0-9]|[3][0-1])[/]([0]?[1-9]|[1][0-2])[/]([0-9]{4})$/;
    document.getElementById('editSubmitButton').addEventListener('click', function(event) {
        const textInput = document.getElementById("change").value.toString(); // Get the value of the text input
        const priorityInput = document.getElementById("priority").value.toString(); // Get the value of the priority input
        const deadlineInput = document.getElementById("deadline").value.toString(); // Get the value of the deadline input
        const todoId = '<%= todo._id %>'; // Get the todo ID from the server-side variable

        if (textInput === "" || priorityInput === "" || deadlineInput === "") {
            window.alert('Please fill in all the fields'); // Show an alert if any field is empty
            return; // Exit the function
        }
        
        if (!regex.test(document.getElementById("deadline").value.toString()) || !isValidDate(deadlineInput)) {
            window.alert('Please enter a valid date in the format dd/mm/yyyy'); // Show an alert if the date is invalid
            return; // Exit the function
        }

        //send the data to the server by using fetch api
        fetch (`/${todoId}`, {
            method: 'PATCH',
            // all the data should be sent in json format and the content should be stringified
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: document.getElementById('change').value,
                priority: document.getElementById('priority').value,
                deadline: document.getElementById('deadline').value
            })
        })
        .then(res => {
            if (res.ok) {
                //if response is okay
                window.alert('Todo updated successfully!'); // Show a success message
                window.location.href = '/'; // Redirect to the home page
            } else {
                //if response is not okay
                console.error('Error updating todo:', res.statusText);
            }
        })
    });
</script>
</html>